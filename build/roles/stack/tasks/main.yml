# docker_stack is a module available since Ansible 2.8, we've imported it ourselves
# https://github.com/ansible/ansible/pull/24588
- name: Deploy
  become: yes
  docker_stack:
    state: present
    name: hacking-portal
    compose:
      - version: '3.7'
        services:
          mongo:
            image: mongo:3.6
            deploy:
              replicas: 3
              restart_policy:
                condition: on-failure
                delay: 5s
            environment:
              - MONGO_INITDB_ROOT_USERNAME="{{mongo_root_user}}"
              - MONGO_INITDB_ROOT_PASSWORD="{{mongo_root_pass}}"

          mongoui:
            image: mongo-express
            deploy:
              replicas: 2
              restart_policy:
                condition: on-failure
                delay: 5s
            ports:
              - 80:8081
            environment:
              - ME_CONFIG_MONGODB_ADMINUSERNAME="{{mongo_root_user}}"
              - ME_CONFIG_MONGODB_ADMINPASSWORD="{{mongo_root_pass}}"
